<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>积分墙-激活</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<link rel="stylesheet" type="text/css" href="style/common.css">
	<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
</head>
<body class="bgGray">
	<div class="registerBlock1 bgWhite">
		<div class="cont bc">
			<p>您已经得到<span class="colorRed">5</span>元，登录即可领取</p>
			<p><a class="btn" href="login.html">已有账号请登录</a></p>
			<i class="aRight"></i>
		</div>
	</div>
	<div class="registerBlock2 bgWhite mt10">
		<p class="bc w88p">您已注册成功，马上激活领取<span class="colorRed">5</span>元</p>
		<input id="username" class="textInput bc mt13" disabled type="text" placeholder="请输入手机号" />
		<div class="cont bc w88p mt13 cf">
			<input id="aCode" class="textInput ml-2 fl" type="text" placeholder="请输入验证码" />
			<a id="btnACode" class="fr" href="javascript:;">获取验证码</a>
			
		</div>
		<a id="submit" class="btnNormal bgRed mt25 bc" href="javascript:;">激活</a>
	</div>
</body>
<script>
// isMobile(valPhone)
var $username = $('#username');
// var $password = $('#password');
var $aCode = $('#aCode');
var $btnACode = $('#btnACode');
var $submit = $('#submit');
var ajaxLoading = false;
var aCodeLoading = false;

var username = getCookie('username');
var userid = getCookie('userid');
if(username){
	$username.val(username);
}

$btnACode.on('click',function(){
	// console.log(post.aCode.replace(':id',getCookie('userid')))
	if(aCodeLoading){
		return;
	}

	$.ajax({
		url : post.aCode.replace(':id',userid),
		beforeSend : function (e){
			aCodeLoading = true;
			$btnACode.addClass('btnDisabled');
		},
		success : function (data){
			var n=60;

			var json = data2json(data);
			console.log(json);

			if(json.code == 200){
				dialog({msg:'激活码已经成功发送到您的手机，60秒之后才能再次获取'});
				setBtn(n);
				var timer = setInterval(function(){
					n--;
					if(n==0){
						clearTimeout(timer);
						aCodeLoading = false;
						$btnACode.removeClass('btnDisabled');
						setBtn();
						return;
					}
					setBtn(n);
				},1000)
				
			}else{
				aCodeLoading = false;
				$btnACode.removeClass('btnDisabled');

				dialog({msg:'获取激活码失败：'+json.msg});
			}
		},
		error : function (e){
			aCodeLoading = false;
			$btnACode.removeClass('btnDisabled');

			dialog({msg:'获取激活码失败：\n网络故障'});
		}
	});
	function setBtn(n){
		if(n){
			$btnACode.text('剩余'+n+'秒');
		}else{
			$btnACode.text('获取验证码');
		}
	}
});



$('#submit').on('click',function(){
	if(ajaxLoading){
		return;
	}

	var aCode = $.trim($aCode.val());

	if(aCode == ''){
		dialog({msg:'请输入验证码'});
		return;
	}

	$.ajax({
		url : post.activate,
		type : 'post',
		data : {
			account : username,
			user_id : userid,
			activate_code : aCode
		},
		beforeSend : function (e){
			ajaxLoading = true;
			$submit.addClass('btnDisabled');
		},
		success : function (data){
			ajaxLoading = false;
			$submit.removeClass('btnDisabled');

			var json = data2json(data);
			console.log(json);

			if(json.code == 200){
				addCookie('username',username,365);
				addCookie('userid',json.user_id,365);
				dialog({
					msg:'激活成功：马上登录领取5元',
					onConfirm : function(){
						window.location.href = 'login.html';
					}
				});
			}else if(json.code == 1001){
				dialog({msg:'激活失败：账号或激活码不正确'});
			}else{
				dialog({msg:'激活失败：'+json.msg});
			}
		},
		error : function (e){
			ajaxLoading = false;
			$submit.removeClass('btnDisabled');

			dialog({msg:'激活失败：\n网络故障'});
		}
	});
});
</script>
</html>