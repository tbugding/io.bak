<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>积分墙-支付宝设置</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<link rel="stylesheet" type="text/css" href="style/common.css">
	<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
</head>
<body class="bgGray">
	<div class="userTopBar bgBlue"><div class="w88p bc pr"><a href="index.html"><i></i>返回首页</a></div></div>
	<div class="userPassword bgWhite">
		<input id="aliAccount" type="text" class="textInput bc" placeholder="支付宝账号" />
		<input id="aliName" type="text" class="textInput bc mt13" placeholder="支付宝姓名" />
		<a id="submit" class="btnNormal bgBlue mt20 bc" href="javascript:;">保存</a>
	</div>
</body>
<script>
var $aliAccount = $('#aliAccount');
var $aliName = $('#aliName');
var $submit = $('#submit');

var userid = getCookie('userid');
var token = getCookie('token');
var username = getCookie('username');

var ajaxLoading = false;

getBalance();

$submit.on('click',function(){
	// bindAlipay($aliName.val(),$aliAccount.val())
	if(ajaxLoading){
		return;
	}

	var aliName = $.trim($aliName.val());
	var aliAccount = $.trim($aliAccount.val());

	if(aliAccount == ''){
		dialog({msg:'请输入支付宝账号'});
		return;
	}

	if(aliName == ''){
		dialog({msg:'请输入支付宝姓名'});
		return;
	}

	$.ajax({
		url : post.saveAliPay,
		type : 'post',
		data : {
			account : username,
			userid : userid,
			token : token,
			aliaccount : aliAccount,
			aliname : aliName
		},
		beforeSend : function (e){
			ajaxLoading = true;
			$submit.addClass('btnDisabled');
		},
		success : function(data){
			ajaxLoading = false;
			$submit.removeClass('btnDisabled');

			var json = data2json(data);
			console.log(json);

			if(json.code == 200){
				dialog({msg:'绑定成功'});
			}else if(json.code == 401){
				breakToken();
			}else{
				dialog({msg:'绑定失败：'+json.message});
			}
		},
		error : function(e){
			ajaxLoading = false;
			$submit.removeClass('btnDisabled');

			dialog({msg:'绑定失败：\n网络故障'});
		}
	})
})

function getBalance(){
	$.ajax({
		url : post.balance,
		type : 'post',
		data : {
			userid : userid,
			token : token
		},
		success : function (data){

			var json = data2json(data);
			console.log(json);

			if(json.code == 200){
				$aliName.val(json.aliname);
				$aliAccount.val(json.aliaccount);

			}else if(json.code == 401 || json.code == 1001){
				breakToken();
			}
		}
	});
}
</script>
</html>