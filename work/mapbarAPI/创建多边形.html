<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<title>绘制任务区域demo</title>
<style>
body,html{ width: 100%; height: 100%;}
body{margin: 0;}
</style>
<script type="text/javascript" src="jq1.11.js"></script>
<script type="text/javascript" src="http://union.mapbar.com/apis/maps/free?f=mapi&v=31.3&k=aCW9cItqL6d6dy4iaSWtdRDpaR1hMeJ9MeV8EeFhMYV5MeJrNIGnMeMh@YeD99eW6RJVihCnMWctM9ht6IEhhiIeehiIFhee81eLMhhMR9IhiIehJMhW9hiJE99eFFl="></script>
<script>
function areaStyle(opt){
	var brush = new MBrush();
    brush.fill = true;
    brush.stroke = 2;
    brush.transparency = 90;

    brush.color = opt.color || '#000000';
    brush.bgcolor = opt.color || '#000000';
    brush.bgtransparency = opt.opacity || 40;

    return brush;
}
function overlayArea(opt){
	var points = opt.points || [];
	var color = '';
	switch(opt.type){
		case 'create':  //新建任务
			color = '#00fe00';
			break;
		case 'processing':  //处理中任务
			color = '#fefe00';
			break;
		case 'cendBack':  //退回任务
			color = '#00fefe';
			break;
		case 'completed':  //已完成任务
			color = '#0000fe';
			break;
		case 'outDate':  //过期任务
			color = '#fe00fe';
			break;
		default :
			color = '#000000';
	}
	var pts = [];

	if(typeof points == 'string'){  //points 是点字符串：如 "116.26381,39.96256;116.38803,39.94137;116.35654,39.87016;116.2225,39.8664;116.21286,39.93228"

		points = points.split(';');
		!points[points.length-1] && points.pop(); //去掉可能存在的点数组最后一项为空的项
		
	}

	if(typeof points[0] == 'object'){  //points 是坐标点对象数组：如 [MPoint, MPoint, MPoint]

		pts = points;

	}else{  //points 是坐标点数组：如 ["116.26381,39.96256", "116.38803,39.94137", "116.35654,39.87016", "116.2225,39.8664", "116.21286,39.93228"]

		(function(){
			for(var i=0; i<points.length; i++){
				var arr = points[i].split(',');
				pts.push(new MPoint(arr[0],arr[1]));
			}
		})()

	}
	
	var brush = areaStyle({
        	color : color,
    		opacity : 40
        })
    var area = new MPolyline(pts,brush);

    MEvent.addListener(area, "mouseover", function(){  
        area.setBrush(areaStyle({
        	color : color,
    		opacity : 60
        }));
    });

    MEvent.addListener(area, "mouseout", function(){  
        area.setBrush(brush);
    });

    // MEvent.addListener(area, "click", function(){  
    //     maplet.addOverlay(new MMarker(  
	   //      this.getCenterPt(),  
	   //      new MIcon("marker.png",20,31),
	   //      new MInfoWindow("<b>marker</b>","aaa") 
	   //  ))
    // });

    MEvent.addListener(area, "click", function(){ 
    	var arr = [];
    	for(var i=0; i<this.pts.length; i++){
    		arr.push(this.pts[i].pid)
    	}
    });
	
	return area;
}

function overlayLine(){

}

function line2area(oLine,type){
	maplet.addOverlay(overlayArea({
		points : oLine.pts,
		type : type
	}));
	maplet.removeOverlay(oLine);
	oLine = null;
}

var maplet = null;
$(function(){
	maplet = new Maplet("mapbar");  
    maplet.centerAndZoom(new MPoint(116.32102,39.93602), 8);
    maplet.addControl(new MStandardControl());
    maplet.setMode('drawarea',areaDrawEnd);
    var newTaskArea = null;
    function areaDrawEnd(obj){
		newTaskArea = overlayArea({
    		points : obj.points,
    		type : 'create'
    	});
    	newTaskArea.setEditable(true);
		maplet.addOverlay(newTaskArea);
    	
    }
    
    $('#btn_clear').on('click',function(){
    	maplet.clearOverlays()
    })
    $('#btn_draw').on('click',function(){
    	if(newTaskArea){
    		var arr = [];
	    	for(var i=0; i<newTaskArea.pts.length; i++){
	    		arr.push(newTaskArea.pts[i].pid);
	    	}
	    	$('#opintsStr').val(arr.join(';'));
	    	newTaskArea.setEditable(false);
	    	newTaskArea = null;
	    	// maplet.setMode('drawarea',areaDrawEnd);

    	}
    })

    $('#btn_create').on('click',function(){
    	// console.log($('#opintsStr').val())
    	maplet.addOverlay(overlayArea({
    		points : $('#opintsStr').val(),
    		type : 'create'
    	}))
    })
}) 
    
//备份
	// areaOpt = {
	// 	points : [
	// 		"116.18796,39.97223",
	// 		"116.41692,39.97496",
	// 		"116.44239,39.92505",
	// 		"116.36957,39.88994",
	// 		"116.25805,39.89361"
	// 	],
	// 	type: 'create'
	// };

	// MEvent.addListener(maplet, "edit", editEnd);
	// var myArea = OverlayArea(opt)
	// myArea.setEditable(true);
    // maplet.addOverlay(myArea);

    	// maplet.addOverlay(overlayArea({
    	// 	points : polyline.pts,
    	// 	type : 'create'
    	// }));

</script>
</head>

<body>
<div id="mapbar" style="width:900px;height:500px"></div>

<button id="btn_draw"> 确定 </button>
<button id="btn_clear"> 清除区域 </button>
<button id="btn_create"> 创建区域 </button>
<br />
<textarea name="" id="opintsStr" cols="100" rows="10"></textarea>


</body>
</html>
